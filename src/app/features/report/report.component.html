<div class="report-container">
    <h2>{{ isEditMode ? 'Editar Reporte' : 'Crear Nuevo Reporte' }}</h2>

    <form [formGroup]="reportForm" (ngSubmit)="onSubmit()" novalidate>

        <div class="form-field">
            <label for="title">T√≠tulo:</label>
            <input type="text" id="title" formControlName="title" placeholder="Ej: Perro perdido cerca del parque">
            <div *ngIf="title?.invalid && (title?.dirty || title?.touched)" class="error-message">
                <span *ngIf="title?.errors?.['required']">El t√≠tulo es obligatorio.</span>
                <span *ngIf="title?.errors?.['minlength']">El t√≠tulo debe tener al menos 5 caracteres.</span>
                <span *ngIf="title?.errors?.['maxlength']">El t√≠tulo no puede exceder los 100 caracteres.</span>
            </div>
        </div>

        <div class="form-field">
            <label for="description">Descripci√≥n:</label>
            <textarea id="description" formControlName="description" rows="4" placeholder="Describe detalladamente lo que sucede..."></textarea>
            <div *ngIf="description?.invalid && (description?.dirty || description?.touched)" class="error-message">
                <span *ngIf="description?.errors?.['required']">La descripci√≥n es obligatoria.</span>
                <span *ngIf="description?.errors?.['minlength']">La descripci√≥n debe tener al menos 10 caracteres.</span>
            </div>
        </div>

        <div class="form-field">
            <label for="categories">Categor√≠as:</label>
            <select id="categories" formControlName="categoryIds" >
                <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
            </select>
            <div *ngIf="categoryIds?.invalid && (categoryIds?.dirty || categoryIds?.touched)" class="error-message">
                <span *ngIf="categoryIds?.errors?.['required'] || categoryIds?.errors?.['minlength']">Debes seleccionar al menos una categor√≠a.</span>
            </div>
        </div>

        <div class="form-field">
            <label>Ubicaci√≥n:</label>
            <div class="search-bar-map">
                <input type="text" #searchInput placeholder="Buscar direcci√≥n..." (keyup.enter)="searchAddress(searchInput.value)" />
                <button type="button" (click)="searchAddress(searchInput.value)">üîç</button>
            </div>
            <div id="map_user" style="width:100%; height:400px;"></div>
            <div *ngIf="(latitude?.invalid || longitude?.invalid) && (latitude?.touched || longitude?.touched)" class="error-message">
                <span>Debes seleccionar una ubicaci√≥n en el mapa.</span>
            </div>
        </div>

        <div class="form-field">
            <label for="selectedFile">Im√°genes (al menos 1):</label>
            <input type="file" id="selectedFile"  formControlName="selectedFile" accept="image/*" (change)="onFileSelected($event)">
            <div class="image-previews" *ngIf="imagePreview">
                <div  class="preview-item">
                    <img [src]="imagePreview" alt="Previsualizaci√≥n">
                    <button type="button" class="remove-preview-btn" (click)="removePreview(0)" title="Quitar imagen">‚úñ</button>
                </div>
            </div>
            <div *ngIf="!isEditMode && !selectedFile && reportForm.touched" class="error-message">
                <span>Debes subir al menos una imagen.</span>
            </div>
        </div>


        <button type="submit" class="submit-button" [disabled]="reportForm.invalid || isLoading || (!isEditMode && !selectedFile)">
            <span *ngIf="!isLoading">{{ isEditMode ? 'Actualizar Reporte' : 'Crear Reporte' }}</span>
            <span *ngIf="isLoading">
          {{ isEditMode ? 'Actualizando...' : 'Creando...' }}
       </span>
        </button>
    </form>
</div>